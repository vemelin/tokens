name: Generate Styles Tokens and Copy

on:
  # Runs on pushes targeting the default branch
  push:
    branches:
      - main

# Sets permissions of the GITHUB_TOKEN to allow deployment
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_tokens:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js environment
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install

      - name: Build Tokens
        run: node build.mjs

      - name: Commit and Push Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Vasiliy"
          git config --global user.email "vasiliy.emelin@solera.com"
          git add -A
          git commit -m "Generate CSS tokens"
          git push origin main

  copy_tokens:
    runs-on: ubuntu-latest
    needs: build_tokens
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Git
        run: |
          git config --global user.name "Vasiliy"
          git config --global user.email "vasiliy.emelin@solera.com"

      - name: Copy Built Tokens
        run: |
          # Clone the destination repository
          git clone https://x-access-token:${{ secrets.DESIGN_TOKEN }}@github.com/Solera-Engineering/global-design-storybook.git destination-repo
          cd destination-repo

          # Create or switch to the target branch
          if git show-ref --verify --quiet refs/heads/main; then
            git checkout main
          else
            git checkout --orphan main
          fi

          # Copy files from the build folder to the destination path
          mkdir -p src/tokens
          cp -r ../build/. src/tokens/

          # Commit and push changes
          git add src/tokens
          git commit -m "Copy SCSS tokens"
          git push origin main